{"id":"df-630528","title":"Niri suspend/resume blank screen bug","description":"## Problem\nAfter suspend-then-hibernate resume on 2026-01-22 at 22:10, the display was blank requiring a hard reset. The kernel and GPU resumed successfully, but niri's compositor session did not render.\n\n## Root Cause Analysis\nExamined journalctl logs from boot -1 (the failed session):\n\n1. **20:38:38** - System initiated suspend-then-hibernate (`PM: suspend entry (deep)`)\n2. **22:10:10** - Kernel woke successfully:\n   - `ACPI: PM: Waking up from system sleep state S3`\n   - `amdgpu: SMU is resumed successfully!`\n   - `PM: suspend exit`\n3. **22:10:11** - **Niri incorrectly paused the session**:\n   ```\n   niri::backend::tty: device changed: 57857\n   niri::backend::tty: device changed: 57856\n   niri::backend::tty: device changed: 57858\n   niri::backend::tty: pausing session\n   ```\n\nAfter \"pausing session\", there were no further niri logs - it got stuck. The rest of the system continued (networking reconnected, tailscale resumed), but the display remained blank.\n\n**Comparison with successful resume (boot -3 at 14:43:44)**: Niri logged nothing during successful resumes - no \"device changed\" or \"pausing session\" messages.\n\n## Additional Errors During Resume\n- xHCI USB controller errors: `xHC error in resume, USBSTS 0x401, Reinit` (on 3 controllers)\n- PCIe bridge window assignment failures (multiple)\n- RODE AI-1 USB audio issues: `cannot set freq 96000 to ep 0x82`\n\n## Related GitHub Issues\n- **#2907** (OPEN) - Display stays black after powering monitor off/on - similar \"device changed\" pattern\n- **#996** (CLOSED) - Main laptop monitor disabled after closing lid - fixed via Smithay\n- **#2265** (CLOSED) - Display reconnection failure - duplicate of #996\n\n## Mitigation Applied\nAdded debug flag to niri config in `home/desktop/default.nix`:\n```nix\ndebug.force-disable-connectors-on-resume = true;\n```\n\nFrom niri docs: \"force-disables all outputs upon resuming niri (TTY switch or waking up from suspend). This causes a modeset/screen blank on all outputs. If niri rendering is corrupted, or monitors don't light up after a TTY switch, you can try this flag.\"\n\n## Environment\n- **niri**: unstable 2026-01-17 (commit d7184a04b904e07113f4623610775ae78d32394c)\n- **Kernel**: 6.18.6\n- **GPU**: AMD (amdgpu driver)\n- **Board**: ASUS ROG CROSSHAIR X670E HERO\n- **CPU**: AMD (7950X3D based on X670E board)\n\n## Next Steps\n1. Test if `force-disable-connectors-on-resume` prevents the issue\n2. If issue persists, consider filing a new bug report on YaLTeR/niri with the \"pausing session\" logs\n3. Alternative recovery: Try Ctrl+Alt+F2 then Ctrl+Alt+F1 to force niri to re-acquire session (untested)","notes":"## Testing pcie_aspm=off (2026-01-23)\n\nAdded `pcie_aspm=off` kernel parameter to completely disable PCIe Active State Power Management.\n\n**Result**: Still fails. Suspend-then-hibernate freezes during 'Restarting tasks' phase even with:\n- RODE device disconnected\n- pcie_aspm=off kernel parameter\n\n### Ruled out causes:\n1. ❌ RODE AI-1 USB device - fails with device disconnected\n2. ❌ PCIe ASPM - fails with pcie_aspm=off\n3. ❌ xHCI controller state - unbinding doesn't help\n\n### Consistent symptoms on every S3 resume:\n- Spurious APIC interrupts on CPUs 17-31 (hyperthreads)\n- PCIe bridge window allocation errors\n- USB context state warnings\n\n### What works vs fails:\n| Operation | Result |\n|-----------|--------|\n| Plain suspend | ✅ Works |\n| Plain hibernate | ✅ Works |\n| Suspend-then-hibernate | ❌ Freezes at 'Restarting tasks' |\n\n### Remaining theories:\n1. RTC alarm wake vs user input wake behaves differently at hardware level\n2. Kernel bug specific to suspend-then-hibernate on AMD X670E + multi-GPU\n3. BIOS/firmware issue with timed wake from S3\n\n### Next steps:\n1. Test with older/newer kernel version\n2. Check BIOS for S3 wake settings\n3. Try disabling one or both NVIDIA GPUs\n4. Search kernel bugzilla for similar reports","status":"open","priority":2,"issue_type":"bug","owner":"gpg@taheris.net","created_at":"2026-01-22T23:09:46Z","created_by":"Shaun Taheri","updated_at":"2026-01-23T12:23:49Z","work_type":"mutex"}
{"id":"df-917","title":"Apple Pro Display XDR brightness control","description":"## Summary\nApple Pro Display XDR brightness control via custom out-of-tree HID kernel driver based on Julius Zint's `apple_bl_usb` patch (submitted to LKML July 2023, never merged because backlight API is designed only for internal panels).\n\n## Changes\n- `packages/apple-display-backlight/apple_bl_usb.c` - HID driver that:\n  - Claims interface 2 for brightness control (range 400-50000, exposed as 0-49600)\n  - Attempts to claim interface 4 to suppress HID parse warnings (see Known Issues)\n  - Creates `/sys/class/backlight/apple_xdr_display`\n  - Supports both Pro Display XDR (05ac:9243) and Studio Display (05ac:1114)\n- `packages/apple-display-backlight/default.nix` - Nix derivation for out-of-tree module\n- `packages/apple-display-backlight/Makefile` - Kernel module build file\n- `packages/default.nix` - Added package to overlay\n- `nixos/hardware-configuration.nix`:\n  - Removed `usbhid.quirks=0x05ac:0x9243:0x0004` (was blocking HID enumeration entirely)\n  - Added `apple_bl_usb` to kernelModules\n  - Added extraModulePackages with the driver\n- `nixos/configuration.nix` - Added udev rule for non-root brightness control\n\n## Known Issues: HID Parse Warnings Not Suppressed\nThe driver does NOT suppress the \"invalid report_size\" kernel warnings at boot:\n```\nhid (null): invalid report_size 32768\nhid (null): invalid report_size 2048\n...\nhid-generic 0003:05AC:9243.000E: probe with driver hid-generic failed with error -22\n```\n\n**Root cause:** The HID core parses device descriptors during USB enumeration, BEFORE any driver's `probe()` function is called. The driver's strategy of returning 0 from probe on interface 4 cannot prevent these errors - they're logged before the driver ever gets control.\n\n**Options considered:**\n1. **Load in initramfs** - Won't help; parsing happens regardless of driver load order\n2. **Use HID_QUIRK_IGNORE** - Would break the driver entirely (it needs HID subsystem)\n3. **Kernel patch to hid-quirks.c** - Proper fix but requires maintaining a kernel patch\n4. **Accept the log spam** - Pragmatic choice; ~15 cosmetic warnings, no functional impact\n\n**Decision:** Accept the log spam. Brightness control works correctly despite the warnings.\n\n## Origin\nBased on Julius Zint's patch: https://lore.kernel.org/lkml/20230701120806.11812-2-julius@zint.sh/\nNot merged upstream because backlight API guarantees single device node (designed for internal panels only).\n\n## Testing\n- Brightness control works: `echo 25000 \u003e /sys/class/backlight/apple_xdr_display/brightness`\n- DMS integration in niri works correctly\n- Module loads and creates backlight device","status":"closed","priority":2,"issue_type":"feature","owner":"gpg@taheris.net","created_at":"2026-01-21T21:55:22Z","created_by":"unknown","updated_at":"2026-01-21T22:04:27Z","closed_at":"2026-01-21T21:55:32Z","work_type":"mutex"}
