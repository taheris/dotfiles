{"id":"df-917","title":"Apple Pro Display XDR brightness control","description":"## Summary\nApple Pro Display XDR brightness control via custom out-of-tree HID kernel driver based on Julius Zint's `apple_bl_usb` patch (submitted to LKML July 2023, never merged because backlight API is designed only for internal panels).\n\n## Changes\n- `packages/apple-display-backlight/apple_bl_usb.c` - HID driver that:\n  - Claims interface 2 for brightness control (range 400-50000, exposed as 0-49600)\n  - Attempts to claim interface 4 to suppress HID parse warnings (see Known Issues)\n  - Creates `/sys/class/backlight/apple_xdr_display`\n  - Supports both Pro Display XDR (05ac:9243) and Studio Display (05ac:1114)\n- `packages/apple-display-backlight/default.nix` - Nix derivation for out-of-tree module\n- `packages/apple-display-backlight/Makefile` - Kernel module build file\n- `packages/default.nix` - Added package to overlay\n- `nixos/hardware-configuration.nix`:\n  - Removed `usbhid.quirks=0x05ac:0x9243:0x0004` (was blocking HID enumeration entirely)\n  - Added `apple_bl_usb` to kernelModules\n  - Added extraModulePackages with the driver\n- `nixos/configuration.nix` - Added udev rule for non-root brightness control\n\n## Known Issues: HID Parse Warnings Not Suppressed\nThe driver does NOT suppress the \"invalid report_size\" kernel warnings at boot:\n```\nhid (null): invalid report_size 32768\nhid (null): invalid report_size 2048\n...\nhid-generic 0003:05AC:9243.000E: probe with driver hid-generic failed with error -22\n```\n\n**Root cause:** The HID core parses device descriptors during USB enumeration, BEFORE any driver's `probe()` function is called. The driver's strategy of returning 0 from probe on interface 4 cannot prevent these errors - they're logged before the driver ever gets control.\n\n**Options considered:**\n1. **Load in initramfs** - Won't help; parsing happens regardless of driver load order\n2. **Use HID_QUIRK_IGNORE** - Would break the driver entirely (it needs HID subsystem)\n3. **Kernel patch to hid-quirks.c** - Proper fix but requires maintaining a kernel patch\n4. **Accept the log spam** - Pragmatic choice; ~15 cosmetic warnings, no functional impact\n\n**Decision:** Accept the log spam. Brightness control works correctly despite the warnings.\n\n## Origin\nBased on Julius Zint's patch: https://lore.kernel.org/lkml/20230701120806.11812-2-julius@zint.sh/\nNot merged upstream because backlight API guarantees single device node (designed for internal panels only).\n\n## Testing\n- Brightness control works: `echo 25000 \u003e /sys/class/backlight/apple_xdr_display/brightness`\n- DMS integration in niri works correctly\n- Module loads and creates backlight device","status":"closed","priority":2,"issue_type":"feature","owner":"gpg@taheris.net","created_at":"2026-01-21T21:55:22.562054163Z","created_by":"unknown","updated_at":"2026-01-21T22:04:10.69162229Z","closed_at":"2026-01-21T21:55:32.472791589Z","close_reason":"Implemented Apple Pro Display XDR brightness control via custom HID kernel driver.\n\n## Changes\n- `packages/apple-display-backlight/apple_bl_usb.c` - HID driver that:\n  - Claims interface 2 for brightness control (range 0-49600)\n  - Claims interface 4 silently to suppress HID parse warnings\n  - Creates `/sys/class/backlight/apple_xdr_display`\n- `packages/apple-display-backlight/default.nix` - Nix derivation\n- `packages/apple-display-backlight/Makefile` - Build file\n- `packages/default.nix` - Added package\n- `nixos/hardware-configuration.nix`:\n  - Removed `usbhid.quirks=0x05ac:0x9243:0x0004` (was blocking HID enumeration)\n  - Added `apple_bl_usb` to kernelModules (loads before hid-generic)\n  - Added extraModulePackages with the driver\n- `nixos/configuration.nix` - Added udev rule for non-root brightness control\n\n## Testing\n- Brightness control works: `echo 25000 \u003e /sys/class/backlight/apple_xdr_display/brightness`\n- Module loads and claims interfaces correctly\n- Pending: verify boot warnings gone after reboot\n\n## If issues after reboot\n- Check `dmesg | grep -i apple` for errors\n- Verify `/sys/class/backlight/apple_xdr_display` exists\n- If warnings persist, module may not be loading early enough"}
