#+title: Doom Emacs Config
#+author: taheris
#+property: header-args:emacs-lisp :tangle yes :comments link
#+property: header-args:elisp :exports code
#+property: header-args :tangle no :results silent :eval no-export
#+startup: fold

* Emacs

** Personal Info

*** Name and email

#+begin_src emacs-lisp
(setq user-full-name "Shaun Taheri"
      user-mail-address "gpg@taheris.net")
#+end_src

*** GPG

#+begin_src emacs-lisp
(setq auth-sources '("~/.authinfo.gpg" "~/.authinfo")
      auth-source-cache-expiry nil
      epa-file-encrypt-to '("gpg@taheris.net"))

(defun my-auth-source-get (&rest params)
  (if-let ((secret (plist-get (car (apply #'auth-source-search params))
                              :secret)))
      (if (functionp secret)
          (funcall secret)
        secret)
    (user-error "auth-search lookup failed for `%s`" params)))
#+end_src

** Global settings

#+begin_src emacs-lisp
(setq-default history-length 1000
              window-combination-resize t
              x-stretch-cursor t)

(setq auto-save-default t
      confirm-kill-emacs nil
      doom-localleader-key ","
      evil-want-fine-undo t
      make-pointer-invisible t
      mouse-drag-copy-region t
      mouse-highlight nil
      scroll-margin 2
      truncate-string-ellipsis "‚Ä¶"
      undo-limit 10485760)
#+end_src

** Encoding

Always use =utf-8= encoding.

#+begin_src emacs-lisp
(set-language-environment 'utf-8)
(set-default-coding-systems 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(prefer-coding-system 'utf-8)
#+end_src

Fix unicode pasting on Windows.

#+begin_src emacs-lisp :tangle (if IS-WINDOWS "yes" "no")
(set-clipboard-coding-system 'utf-16-le)
(set-selection-coding-system 'utf-16-le)
#+end_src

** Customisations

Use a separate file for customisations rather than =init.el=.

#+begin_src emacs-lisp
(setq-default custom-file (expand-file-name ".custom.el" doom-private-dir))

(when (file-exists-p custom-file)
  (load custom-file))
#+end_src

** Frame title

An example of an unedited title would be =config.org ‚óè dotfiles=, while an
edited buffer would be =config.org ‚óâ dotfiles=.

#+begin_src emacs-lisp
(setq frame-title-format
      '(""
        (:eval
         (if (s-contains-p org-roam-directory (or buffer-file-name ""))
             (replace-regexp-in-string ".*/[0-9]*-?" "‚ò∞ " (subst-char-in-string ?_ ?  buffer-file-name))
           "%b"))
        (:eval
         (let ((project-name (projectile-project-name)))
           (unless (string= "-" project-name)
             (format (if (buffer-modified-p)  " ‚óâ %s" " ‚ÄÜ‚óè‚ÄÜ %s") project-name))))))
#+end_src

** Line wrapping

Use ~auto-fill-mode~ instead of ~visual-line-mode~ for line wrapping with explicit
newline characters.

#+begin_src emacs-lisp
(remove-hook 'text-mode-hook #'visual-line-mode)
(add-hook 'text-mode-hook #'auto-fill-mode)
#+end_src

** Terminal

#+begin_src emacs-lisp
(setq vterm-always-compile-module t)
#+end_src

#+begin_src emacs-lisp :tangle (if IS-WINDOWS "no" "yes")
(setq shell-file-name "/run/current-system/sw/bin/zsh"
      explicit-shell-file-name "/run/current-system/sw/bin/zsh"
      vterm-shell "/run/current-system/sw/bin/zsh")
#+end_src

* Doom

** Modules
:PROPERTIES:
:header-args:emacs-lisp: :tangle no
:END:

*** Layout

Define the =init.el= file structure.

#+name: init.el
#+begin_src emacs-lisp :tangle "init.el" :noweb no-export :comments no
;;; init.el -*- lexical-binding: t; -*-

(doom! :input
       <<doom-input>>

       :completion
       <<doom-completion>>

       :ui
       <<doom-ui>>

       :editor
       <<doom-editor>>

       :emacs
       <<doom-emacs>>

       :term
       <<doom-term>>

       :checkers
       <<doom-checkers>>

       :tools
       <<doom-tools>>

       :os
       <<doom-os>>

       :lang
       <<doom-lang>>

       :email
       <<doom-email>>

       :app
       <<doom-app>>

       :config
       <<doom-config>>
       )
#+end_src

*** Input

#+name: doom-input
#+begin_src emacs-lisp
;;bidi                       ; (tfel ot) thgir etirw uoy gnipleh
;;chinese
;;japanese
;;layout                     ; auie,ctsrnm is the superior home row
#+end_src

*** Completion

#+name: doom-completion
#+begin_src emacs-lisp
;(company                     ; the ultimate code completion backend
; +childframe)                ; ... when your children are better than you
 ;+tng)
(corfu                       ; complete with cap(f), cape and a flying feather!
 ;+dabbrev
 +icons
 +orderless)
;;helm                       ; the *other* search engine for love and life
;;ido                        ; the other *other* search engine...
;;(ivy                       ; a search engine for love and life
;; +icons                    ; ... icons are nice
;; +prescient)               ; ... I know what I want(ed)
(vertico +icons)             ; the search engine of the future
#+end_src

*** UI

#+name: doom-ui
#+begin_src emacs-lisp
;;deft                       ; notational velocity for Emacs
doom                         ; what makes DOOM look the way it does
;;doom-dashboard             ; a nifty splash screen for Emacs
;;doom-quit                  ; DOOM quit-message prompts when you quit Emacs
(emoji +unicode)             ; üôÇ
hl-todo                      ; highlight TODO/FIXME/NOTE/DEPRECATED/HACK/REVIEW
;;indent-guides              ; highlighted indent columns, notoriously slow
;;(ligatures +extra)         ; ligatures and symbols to make your code pretty again
;;minimap                    ; show a map of the code on the side
modeline                     ; snazzy, Atom-inspired modeline, plus API
nav-flash                    ; blink the current line after jumping
;;neotree                    ; a project drawer, like NERDTree for vim
ophints                      ; highlight the region an operation acts on
(popup                       ; tame sudden yet inevitable temporary windows
 ;+all                       ; catch all popups that start with an asterix
 +defaults)                  ; default popup rules
;;smooth-scroll              ; So smooth you won't believe it's not butter
;;(tabs                      ; an tab bar for Emacs
;;  +centaur-tabs)           ; ... with prettier tabs
treemacs                     ; a project drawer, like neotree but cooler
;;unicode                    ; extended unicode support for various languages
(vc-gutter +pretty)          ; vcs diff in the fringe
vi-tilde-fringe              ; fringe tildes to mark beyond EOB
(window-select +numbers)     ; visually switch windows
workspaces                   ; tab emulation, persistence & separate workspaces
zen                          ; distraction-free coding or writing
#+end_src

*** Editor

#+name: doom-editor
#+begin_src emacs-lisp
(evil +everywhere)           ; come to the dark side, we have cookies
file-templates               ; auto-snippets for empty files
fold                         ; (nigh) universal code folding
(format +onsave)             ; automated prettiness
;;god                        ; run Emacs commands without modifier keys
;;lispy                      ; vim for lisp, for people who don't like vim
multiple-cursors             ; editing in many places at once
;;objed                      ; text object editing for the innocent
;;parinfer                   ; turn lisp into python, sort of
rotate-text                  ; cycle region at point between text candidates
snippets                     ; my elves. They type so I don't have to
(whitespace                  ; a butler for your whitespace
 +guess
 +trim)
word-wrap                    ; soft wrapping with language-aware indent
#+end_src

*** Emacs

#+name: doom-emacs
#+begin_src emacs-lisp
(dired +icons)               ; making dired pretty [functional]
electric                     ; smarter, keyword-based electric-indent
;;eww                        ; the internet is gross
(ibuffer +icons)             ; interactive buffer management
(undo +tree)                 ; persistent, smarter undo for your inevitable mistakes
vc                           ; version-control and Emacs, sitting in a tree
#+end_src

*** Term

#+begin_src emacs-lisp
;;eshell                     ; the elisp shell that works everywhere
;;shell                      ; simple shell REPL for Emacs
term                         ; basic terminal emulator for Emacs
vterm                        ; the best terminal emulation in Emacs
#+end_src

*** Checkers

#+name: doom-checkers
#+begin_src emacs-lisp
syntax                       ; tasing you for every semicolon you forget
(spell +aspell)              ; tasing you for misspelling mispelling
grammar                      ; tasing grammar mistake every you make
#+end_src

*** Tools

#+name: doom-tools
#+begin_src emacs-lisp
;;ansible                    ; a crucible for infrastructure as code
;;biblio                     ; Writes a PhD for you (citation needed)
;;collab                     ; buffers with friends
(debugger +lsp)              ; FIXME stepping through code, to help you add bugs
direnv                       ; be direct about your environment
docker                       ; port everything to containers
;;editorconfig               ; let someone else argue about tabs vs spaces
;;ein                        ; tame Jupyter notebooks with emacs
(eval +overlay)              ; run code, run (also, repls)
llm                          ; when I said you needed friends, I didn't mean...
(lookup                      ; helps you navigate your code and documentation
 +dictionary                 ; dictionary/thesaurus is nice
 +docsets)                   ; ...or in Dash docsets locally
(lsp +peek)                  ; Language Server Protocol
(magit                       ; a git porcelain for Emacs
 +forge)                     ; interface with git forges
make                         ; run make tasks from Emacs
;;pass                       ; password manager for nerds
pdf                          ; pdf enhancements
terraform                    ; infrastructure as code
tmux                         ; an API for interacting with tmux
tree-sitter                  ; syntax and parsing, sitting in a tree...
upload                       ; map local to remote projects via ssh/ftp
#+end_src

*** OS

#+name: doom-os
#+begin_src emacs-lisp
(:if IS-MAC macos)           ; improve compatibility with macOS
(tty +osc)                   ; improve the terminal Emacs experience
#+end_src

*** Lang

#+name: doom-lang
#+begin_src emacs-lisp
;;agda                       ; types of types of types of types...
;;beancount                  ; mind the GAAP
;;(cc +lsp)                  ; C > C++ == 1
;;clojure                    ; java with a lisp
;;common-lisp                ; if you've seen one lisp, you've seen them all
;;coq                        ; proofs-as-programs
;;crystal                    ; ruby at the speed of c
;;csharp                     ; unity, .NET, and mono shenanigans
data                         ; config/data formats
;;(dart +flutter)            ; paint ui and not much else
;;dhall                      ; JSON with FP sprinkles
;;elixir                     ; erlang done right
;;elm                        ; care for a cup of TEA?
emacs-lisp                   ; drown in parentheses
;;erlang                     ; an elegant language for a more civilized age
;;ess                        ; emacs speaks statistics
;;factor                     ; for when scripts are stacked against you
;;faust                      ; dsp, but you get to keep your soul
;;fortran                    ; in FORTRAN, GOD is REAL (unless declared INTEGER)
;;fsharp                     ; ML stands for Microsoft's Language
;;fstar                      ; (dependent) types and (monadic) effects and Z3
;;gdscript                   ; the language you waited for
(go                          ; the hipster dialect
 +lsp
 +tree-sitter)
(graphql +lsp)               ; Give queries a REST
;;graphviz                     ; diagrams for confusing yourself even more
;;(haskell +lsp)             ; a language that's lazier than I am
;;hy                         ; readability of scheme w/ speed of python
;;idris                      ; a language you can depend on
;;janet                      ; Fun fact: Janet is me!
;;(java +lsp)                ; the poster child for carpal tunnel syndrome
(javascript                  ; all(hope(abandon(ye(who(enter(here))))))
 +lsp
 +tree-sitter)
(json                        ; At least it ain't XML
 +lsp
 +tree-sitter)
(julia                       ; Python, R, and MATLAB in a blender
 +lsp
 +tree-sitter)
;;kotlin                     ; a better, slicker Java(Script)
(latex                       ; writing papers in Emacs has never been so fun
 +latexmk                    ; what else would you use?
 ;+cdlatex                   ; quick maths symbols
 +fold)                      ; fold the clutter away nicities
;;lean                       ; proof that mathematicians need help
;;ledger                     ; an accounting system in Emacs
;;lua                        ; one-based indices? one-based indices
markdown                     ; writing docs for people to ignore
;;nim                        ; python + lisp at the speed of c
(nix                         ; I hereby declare "nix geht mehr!"
 +lsp
 +treesitter)
;;ocaml                      ; an objective camel
(org                         ; organize your plain life in plain text
 ;;+brain
 ;;+contacts
 ;;+crypt
 +dragndrop                  ; drag & drop files/images into org buffers
 +gnuplot                    ; who doesn't like pretty pictures
 ;;+hugo                     ; use Emacs for hugo blogging
 +journal
 +jupyter                    ; ipython/jupyter support for babel
 +noter                      ; enhanced PDF notetaking
 +pandoc                     ; export-with-pandoc support
 ;;+passwords
 ;;+pomodoro                 ; be fruitful with the tomato technique
 +present                    ; using org-mode for presentations
 +pretty                     ; yessss my pretties! (nice unicode symbols)
 +roam2)                     ; wander around notes
;;php                        ; perl's insecure younger brother
;;plantuml                   ; diagrams for confusing people more
;;purescript                 ; javascript, but functional
(python                      ; beautiful is better than ugly
 +lsp
 +pyright
 +tree-sitter)
;;qt                         ; the 'cutest' gui framework ever
(racket                      ; a DSL for DSLs
 +lsp
 +xp)
;;raku                       ; the artist formerly known as perl6
;;rest                       ; Emacs as a REST client
;;rst                        ; ReST in peace
;;(ruby +rails)              ; 1.step {|i| p "Ruby is #{i.even? ? 'love' : 'life'}"}
(rust                        ; Fe2O3.unwrap().unwrap().unwrap().unwrap()
 +lsp
 +tree-sitter)
;;scala                      ; java, but good
(scheme +guile)              ; a fully conniving family of lisps
(sh                          ; she sells {ba,z,fi}sh shells on the C xor
 +lsp
 +powershell
 +tree-sitter)
;;sml                        ; no, the /other/ ML
;;solidity                   ; do you need a blockchain? No.
;(swift                      ; who asked for emoji variables?
; +lsp
; +tree-sitter)
;;terra                      ; Earth and Moon in alignment for performance.
(web                         ; the tubes
 +lsp
 +tree-sitter)
(yaml                        ; JSON, but readable
 +lsp)
;;zig                        ; C, but simpler
#+end_src

*** Email

#+name: doom-email
#+begin_src emacs-lisp
;;(mu4e +org +gmail)
;;notmuch
;;(wanderlust +gmail)
#+end_src

*** App

#+name: doom-app
#+begin_src emacs-lisp
;;calendar                   ; A dated approach to timetabling
;;emms                       ; Multimedia in Emacs is music to my ears
everywhere                   ; *leave* Emacs!? You must be joking.
irc                          ; how neckbeards socialize
(rss +org)                   ; emacs as an RSS reader
#+end_src

*** Config

#+name: doom-config
#+begin_src emacs-lisp
literate
(default +bindings +smartparens)
#+end_src

** Visual settings

*** Theme

#+begin_src emacs-lisp
(setq doom-theme 'doom-material)

(remove-hook 'window-setup-hook #'doom-init-theme-h)
(add-hook 'after-init-hook #'doom-init-theme-h 'append)

(delq! t custom-theme-load-path)
#+end_src

*** Fonts

#+begin_src emacs-lisp :tangle (if IS-LINUX "yes" "no")
(setq doom-font (font-spec :family "MonacoB Nerd Font Mono" :size 17)
      doom-big-font (font-spec :family "MonacoB Nerd Font Mono" :size 24)
      doom-variable-pitch-font (font-spec :family "Bookerly")
      doom-serif-font (font-spec :family "Bookerly")
      doom-unicode-font (font-spec :family "JuliaMono"))
#+end_src

#+begin_src emacs-lisp :tangle (if IS-MAC "yes" "no")
(setq doom-font (font-spec :family "MonacoB Nerd Font Mono" :size 16)
      doom-big-font (font-spec :family "MonacoB Nerd Font Mono" :size 22)
      doom-variable-pitch-font (font-spec :family "Bookerly" :size 18)
      doom-serif-font (font-spec :family "Bookerly")
      doom-unicode-font (font-spec :family "JuliaMono"))
#+end_src

#+begin_src emacs-lisp :tangle (if IS-WINDOWS "yes" "no")
(setq doom-font (font-spec :family "MonoLisa ss01 ss03 ss06 zero" :size 32 :weight 'medium)
      doom-big-font (font-spec :family "MonoLisa ss01 ss03 ss06 zero" :size 48 :weight 'medium)
      doom-variable-pitch-font (font-spec :family "Bookerly")
      doom-serif-font (font-spec :family "Bookerly")
      doom-unicode-font (font-spec :family "JuliaMono"))
#+end_src

Set modes for font ligatures.

#+begin_src emacs-lisp
(setq +ligatures-in-modes '(org-mode)
      +ligatures-extras-in-modes '(org-mode)
      +ligatures-prog-mode-list nil)

(set-font-ligatures! 'prog-mode nil)
#+end_src

*** Modeline

Only show file encoding if it's not =UTF-8= or with =LF= endings.

#+begin_src emacs-lisp
(setq doom-modeline-default-eol-type 0)
#+end_src

Default buffer names.

#+begin_src emacs-lisp
(setq doom-fallback-buffer-name "‚ñ∫ Doom"
      +doom-dashboard-name "‚ñ∫ Doom")
#+end_src

*** Line Numbers

#+begin_src emacs-lisp
(setq display-line-numbers-type 'relative)
#+end_src

** Other settings

*** Workspace

Easier movement between workspaces.

#+begin_src emacs-lisp
(map! :leader
      (:prefix ("TAB" . "workspace")
        :desc "Switch to"    "SPC" #'+workspace/switch-to
        :desc "Switch left"  "h"   #'+workspace/switch-left
        :desc "Switch right" "l"   #'+workspace/switch-right
        :desc "Swap left"    "H"   #'+workspace/swap-left
        :desc "Swap right"   "L"   #'+workspace/swap-right))
#+end_src

*** Errors

Define some keybindings for error handling.

#+begin_src emacs-lisp
(map! :leader
      (:prefix ("e" . "error")
        :desc "clear"            "c" #'flycheck-clear
        :desc "display at point" "d" #'flycheck-display-error-at-point
        :desc "explain at point" "e" #'flycheck-explain-error-at-point
        :desc "list errors"      "l" #'flycheck-list-errors
        :desc "next error"       "n" #'flycheck-next-error
        :desc "previous error"   "p" #'flycheck-previous-error
        :desc "select checker"   "s" #'flycheck-select-checker

        (:prefix ("D" . "debug")
         :desc "toggle debug on error" "t" #'toggle-debug-on-error
         :desc "set breakpoint"        "b" #'edebug-defun
         :desc "undo breakpoint"       "u" #'eval-defun)))
#+end_src

*** Formatting

#+begin_src emacs-lisp
(setq +format-on-save-disabled-modes
      (cl-remove 'sql-mode +format-on-save-disabled-modes))

(after! apheleia
  (let ((entry (assoc 'pgformatter apheleia-formatters)))
    (when entry
      (setcdr entry (list "pg_format" "--keyword-case" "1"
                          '(apheleia-formatters-indent "--tabs" "--spaces" 'tab-width)
                          '(apheleia-formatters-fill-column "--wrap-limit"))))))
#+end_src

*** Popup

Define some global popup rules.

#+begin_src emacs-lisp
(set-popup-rules!
 '(("\\*doom:scratch\\*" :side right :size 0.33 :quit nil :modeline t :select t)
   ("\\*helpful-*" :side right :size 0.33 :quit nil :modeline t)
   ("\\*Flycheck errors\\*" :side right :size 0.33 :quit nil :modeline t)))
#+end_src

*** Writeroom

Reduce zoom size.

#+begin_src emacs-lisp
(setq +zen-text-scale 0.8)
#+end_src

* Packages

** Setup

The =packages.el= file shouldn't be byte compiled.

#+begin_src emacs-lisp :tangle "packages.el" :comments no
;; -*- no-byte-compile: t; -*-
#+end_src

** Which key

Reduce the delay time before popup, and trim =evil-= from popup names.

#+begin_src emacs-lisp
(setq which-key-idle-delay 0.4
      which-key-allow-multiple-replacements t)

(which-key-mode +1)

(after! which-key
  (pushnew! which-key-replacement-alist
            '(("" . "\\`+?evil[-:/]?\\(?:a-\\)?\\(.*\\)") . (nil . "‚óÇ\\1"))
            '(("\\`g s" . "\\`evilem--?motion-\\(.*\\)") . (nil . "‚óÉ\\1"))))
#+end_src

** Evil

Change some settings from the vim defaults.

#+begin_src emacs-lisp
(after! evil
  (setq evil-ex-substitute-global t
        evil-kill-on-visual-paste nil
        evil-move-cursor-back nil
        evil-split-window-below t
        evil-vsplit-window-right t))
#+end_src

Remove unused ~evil-escape-mode~ package which watches insert-mode keystrokes.

#+begin_src emacs-lisp :tangle packages.el
(package! evil-escape :disable t)
#+end_src

** Projectile

Ignore some ~projectile~ paths.

#+begin_src emacs-lisp
(setq projectile-enable-caching nil
      projectile-ignored-projects
      '("~/"
        "~/Documents"
        "~/.emacs.d/.local/straight/repos/"
        "/tmp"))

(defun projectile-ignored-project-function (filepath)
  "Return t if FILEPATH is within any of `projectile-ignored-projects'"
  (or (mapcar (lambda (p) (s-starts-with-p p filepath)) projectile-ignored-projects)))

(map! :leader
      (:prefix ("p" . "+project")
        :desc "Multi-occur" "/" #'projectile-multi-occur))
#+end_src

** Ispell

Set ~ispell~ program and dictionaries.

#+begin_src emacs-lisp
(setq ispell-program-name (if IS-WINDOWS "aspell.exe" "aspell")
      ispell-dictionary "en"
      ispell-personal-dictionary (expand-file-name ".ispell_personal" doom-private-dir))
#+end_src

Manually set ~spell-fu~ modes.

#+begin_src emacs-lisp
(after! spell-fu
  (remove-hook 'text-mode-hook #'spell-fu-mode)
  (add-hook 'markdown-mode-hook #'spell-fu-mode))
#+end_src

** String inflection

Change the case pattern for a symbol.

#+begin_src emacs-lisp :tangle packages.el
(package! string-inflection :pin "4a2f87d7b47f5efe702a78f8a40a98df36eeba13")
#+end_src

#+begin_src emacs-lisp
(use-package! string-inflection
  :commands (string-inflection-all-cycle
             string-inflection-toggle
             string-inflection-camelcase
             string-inflection-lower-camelcase
             string-inflection-kebab-case
             string-inflection-underscore
             string-inflection-capital-underscore
             string-inflection-upcase)

  :init
  (map! :leader :prefix ("c~" . "naming convention")
        :desc "cycle"       "~" #'string-inflection-all-cycle
        :desc "toggle"      "t" #'string-inflection-toggle
        :desc "CamelCase"   "c" #'string-inflection-camelcase
        :desc "downCase"    "d" #'string-inflection-lower-camelcase
        :desc "kebab-case"  "k" #'string-inflection-kebab-case
        :desc "under_score" "_" #'string-inflection-underscore
        :desc "Upper_Score" "u" #'string-inflection-capital-underscore
        :desc "UP_CASE"     "U" #'string-inflection-upcase)

  (after! evil
    (evil-define-operator evil-operator-string-inflection (beg end _type)
      "Define a new evil operator that cycles symbol casing."
      :move-point nil
      (interactive "<R>")
      (string-inflection-all-cycle)
      (setq evil-repeat-info '([?g ?~])))

    (define-key evil-normal-state-map (kbd "g~") 'evil-operator-string-inflection)))
#+end_src

** Smartparens

#+begin_src emacs-lisp
(after! smartparens
  (sp-with-modes '(org-mode)
    (sp-local-pair "<<" ">>" :actions '(insert)))

  (map! :map smartparens-mode-map
        :nvie "s-a" #'sp-beginning-of-sexp
        :nvie "s-e" #'sp-end-of-sexp
        :nvie "s-h" #'sp-backward-up-sexp
        :nvie "s-j" #'sp-next-sexp
        :nvie "s-k" '(lambda () (interactive) (sp-next-sexp -1))
        :nvie "s-l" #'sp-down-sexp
        :nvie "s-f" #'sp-forward-sexp
        :nvie "s-b" #'sp-backward-sexp
        :nvie "s-d" #'sp-kill-sexp
        :nvie "s-D" #'sp-backward-kill-sexp
        :nvie "s-J" #'sp-join-sexp))
#+end_src

** Snap indent

Automatic indentation on yank/paste.

#+begin_src emacs-lisp :tangle packages.el
(package! snap-indent :recipe (:host github :repo "jeffvalk/snap-indent")
  :pin "0bac6b7eca59793cd0d810d85658b2a5dd05d5d9")
#+end_src

#+begin_src emacs-lisp
(use-package! snap-indent
  :hook (prog-mode . snap-indent-mode)
  :config
  (setq snap-indent-format 'untabify
        snap-indent-commands '(yank yank-pop evil-yank evil-paste-before evil-paste-after))

  (defun snap-indent-command-handler ()
    "Indent region text on yank."
    (when (memq this-command snap-indent-commands)
      (snap-indent-indent (region-beginning) (region-end)))))
#+end_src

** Circe

#+begin_src emacs-lisp
(setq circe-default-user "proto1"
      circe-default-nick "proto1"
      circe-default-realname "proto1")

(set-irc-server! "irc.libera.chat"
  '(:tls t
    :port 6697
    :sasl-username "proto1"
    :sasl-password (lambda (server) (my-auth-source-get :user "proto1" :host "irc.libera.chat"))))
#+end_src

** Info colors

Extra colors for Emacs's Info-mode

#+begin_src emacs-lisp :tangle packages.el
(package! info-colors :pin "2e237c301ba62f0e0286a27c1abe48c4c8441143")
#+end_src

#+begin_src emacs-lisp
(use-package! info-colors
  :commands (info-colors-fontify-node))

(add-hook 'Info-selection-hook 'info-colors-fontify-node)
#+end_src

** Emojify

Use Twitter's emoji set instead of ~emoji-one~.

#+begin_src emacs-lisp
(setq emojify-emoji-set "twemoji-v2")
#+end_src

Disable for certain symbols.

#+begin_src emacs-lisp
(defvar emojify-disabled-emojis
  '(;; Org
    "‚óº" "‚òë" "‚ò∏" "‚öô" "‚è©" "‚è™" "‚¨Ü" "‚¨á" "‚ùì"
    ;; Terminal powerline
    "‚úî"
    ;; Box drawing
    "‚ñ∂" "‚óÄ")
  "Characters that should never be affected by `emojify-mode'.")

(defadvice! emojify-delete-from-data ()
  "Ensure `emojify-disabled-emojis' don't appear in `emojify-emojis'."
  :after #'emojify-set-emoji-data
  (dolist (emoji emojify-disabled-emojis)
    (remhash emoji emojify-emojis)))
#+end_src

** Page break lines

Display the =^L= page break character as horizontal rules.

#+begin_src emacs-lisp :tangle packages.el
(package! page-break-lines
  :recipe (:host github :repo "purcell/page-break-lines"))
#+end_src

#+begin_src emacs-lisp
(use-package! page-break-lines
  :commands page-break-lines-mode
  :init
  (autoload 'turn-on-page-break-lines-mode "page-break-lines")
  :config
  (setq page-break-lines-max-width fill-column)
  (map! :prefix "g"
        :desc "Prev page break" :nv "[" #'backward-page
        :desc "Next page break" :nv "]" #'forward-page))
#+end_src

** Writegood

Turn off passive-voice checking.

#+begin_src emacs-lisp
(after! writegood-mode
  (add-hook 'writegood-mode-hook #'writegood-duplicates-turn-off)
  (add-hook 'writegood-mode-hook #'writegood-passive-voice-turn-off))
#+end_src

* Applications

** Calculator

Set =calc= defaults.

#+begin_src emacs-lisp
(setq calc-angle-mode 'rad
      calc-symbolic-mode t)
#+end_src

*** CalcTeX

#+begin_src emacs-lisp :tangle packages.el
(package! calctex
  :recipe (:host github
           :repo "johnbcoughlin/calctex"
           :files ("*.el" "calctex/*.el" "calctex-contrib/*.el" "org-calctex/*.el" "vendor"))
  :pin "67a2e76847a9ea9eff1f8e4eb37607f84b380ebb")
#+end_src

#+begin_src emacs-lisp
(use-package! calctex
  :commands calctex-mode
  :init
  (add-hook 'calc-mode-hook #'calctex-mode)
  :config
  (setq calctex-additional-latex-macros (concat calctex-additional-latex-macros "\n\\let\\evalto\\Rightarrow")
        calctex-additional-latex-packages "
\\usepackage[usenames]{xcolor}
\\usepackage{soul}
\\usepackage{adjustbox}
\\usepackage{amsmath}
\\usepackage{amssymb}
\\usepackage{siunitx}
\\usepackage{cancel}
\\usepackage{mathtools}
\\usepackage{mathalpha}
\\usepackage{xparse}
\\usepackage{arevmath}")

  (defadvice! no-messaging-a (orig-fn &rest args)
    :around #'calctex-default-dispatching-render-process
    (let ((inhibit-message t) message-log-max)
      (apply orig-fn args)))

  ;; Fix hardcoded dvichop path
  (let ((vendor-folder (concat (file-truename doom-local-dir) "straight/" (format "build-%s" emacs-version) "/calctex/vendor/")))
    (setq calctex-dvichop-sty (concat vendor-folder "texd/dvichop")
          calctex-dvichop-bin (concat vendor-folder "texd/dvichop")))

  (unless (file-exists-p calctex-dvichop-bin)
    (message "CalcTeX: Building dvichop binary")
    (let ((default-directory (file-name-directory calctex-dvichop-bin)))
      (call-process "make" nil nil nil))))
#+end_src

** Org

*** Packages

**** Babel Mermaid

#+begin_src emacs-lisp :tangle packages.el
(package! ob-mermaid
  :recipe (:host github :repo "arnm/ob-mermaid")
  :pin "372c2d91d3cdba5da9f7ac23e7bce7a0b3b46862")
#+end_src

#+begin_src emacs-lisp :tangle (if IS-MAC "yes" "no")
(setq ob-mermaid-cli-path "/opt/homebrew/bin/mmdc")
#+end_src

**** SRS

#+begin_src emacs-lisp :tangle packages.el
(package! fsrs)

(package! org-srs
  :recipe (:host github :repo "bohonghuang/org-srs")
  :pin "2a7b49854b65d116f929f1ae193bd2365f2f9b0c")
#+end_src

#+begin_src emacs-lisp
(after! org-srs
  (map! :localleader
        :map org-mode-map
        :prefix ("z" . "SRS")

        :desc "Create item"   "c" #'org-srs-item-create

        :desc "Start review"   "r" #'org-srs-review-start
        :desc "Quit review"    "q" #'org-srs-review-quit
        :desc "Suspend review" "z" #'org-srs-review-suspend

        :desc "Rate again" "a" #'org-srs-review-rate-again
        :desc "Rate easy"  "e" #'org-srs-review-rate-easy
        :desc "Rate good"  "g" #'org-srs-review-rate-good
        :desc "Rate hard"  "h" #'org-srs-review-rate-hard)

  (add-hook! org-mode #'org-srs-embed-overlay-mode))
#+end_src

*** Behaviour

**** Setup

#+begin_src emacs-lisp
(setq org-directory "~/src/github.com/taheris/org"
      org-roam-directory (concat org-directory "/roam")
      org-catch-invisible-edits 'smart
      org-export-allow-bind-keywords t
      org-export-with-sub-superscripts '{}
      org-image-actual-width nil
      org-image-max-width nil
      org-list-allow-alphabetical t
      org-log-done 'time
      org-use-property-inheritance t)
#+end_src

Add a newline when inserting new headings.

#+begin_src emacs-lisp
(setq org-blank-before-new-entry
      '((heading . t)
        (plain-list-item . auto)))
#+end_src

Don't trim trailing whitespaces.

#+begin_src emacs-lisp
(after! ws-butler
  (add-to-list 'ws-butler-global-exempt-modes 'org-mode))
#+end_src

Fix for https://github.com/emacs-lsp/lsp-mode/issues/4898

#+begin_src emacs-lisp
(defun lsp--detect-org-element-api--always-true (orig-fun &rest args) t)

(advice-add 'lsp--detect-org-element-api :around #'lsp--detect-org-element-api--always-true)
#+end_src

**** Display

#+begin_src emacs-lisp
(after! org
  (setq org-ellipsis " ‚ñæ"
        org-modern-star '("‚óâ" "‚óã" "‚ú∏" "‚úø" "‚ú§" "‚úú" "‚óÜ" "‚ñ∂")
        org-modern-list '((43 . "‚û§")
                          (45 . "‚Äì")
                          (42 . "‚Ä¢"))
        org-modern-block-fringe nil
        org-modern-block-name '((t . t)
                                ("src" "¬ª" "¬´")
                                ("example" "¬ª‚Äì" "‚Äì¬´")
                                ("quote" "‚ùù" "‚ùû")
                                ("export" "‚è©" "‚è™"))
        org-modern-keyword '((t . t)
                             ("title" . "ùôè")
                             ("subtitle" . "ùô©")
                             ("author" . "ùòº")
                             ("email" . #("ÓÉ°" 0 1 (display (raise -0.14))))
                             ("date" . "ùòø")
                             ("property" . "‚ò∏")
                             ("options" . "‚å•")
                             ("startup" . "‚èª")
                             ("macro" . "ùìú")
                             ("bind" . #("ÓÖó" 0 1 (display (raise -0.1))))
                             ("bibliography" . "ÔêÖ")
                             ("cite_export" . "ÔêÖ‚Æ≠")
                             ("include" . "‚á§")
                             ("setupfile" . "‚áö")
                             ("html_head" . "üÖ∑")
                             ("html" . "üÖó")
                             ("latex" . "üÖõ")
                             ("latex_class" . "üÑª")
                             ("latex_header" . "üÖª")
                             ("latex_header_extra" . "üÖª‚Å∫")
                             ("attr_latex" . "üÑõ")
                             ("attr_html" . "üÑó")
                             ("attr_org" . "‚í™")
                             ("name" . "‚Åç")
                             ("header" . "‚Ä∫")
                             ("caption" . "‚ò∞")
                             ("results" . "ü†∂"))))

(custom-set-faces!
  '(org-document-title :height 1.2)
  '(outline-1 :weight extra-bold :height 1.18)
  '(outline-2 :weight bold :height 1.15)
  '(outline-3 :weight bold :height 1.12)
  '(outline-4 :weight semi-bold :height 1.09)
  '(outline-5 :weight semi-bold :height 1.06)
  '(outline-6 :weight semi-bold :height 1.03)
  '(outline-8 :weight semi-bold)
  '(outline-9 :weight semi-bold))
#+end_src

**** Keybindings

#+begin_src emacs-lisp
(after! org
  (map! :map org-mode-map
        :ni "C-<return>" #'org-insert-heading
        :ni "S-<return>" #'org-insert-subheading
        :i  [return]     (cmd! (org-return electric-indent-mode)))

  (map! :map evil-org-mode-map
        :ni "C-<return>" #'evil-org-org-insert-heading-respect-content-below))
#+end_src

**** View export

View exported file with ='localeader v=.

#+begin_src emacs-lisp
(map! :map org-mode-map
      :localleader
      :desc "View exported file" "v" #'org-view-output-file)

(defun org-view-output-file (&optional org-file-path)
  "Visit buffer open on the first output file found."
  (interactive)
  (let* ((org-file-path (or org-file-path (buffer-file-name) ""))
         (dir (file-name-directory org-file-path))
         (basename (file-name-base org-file-path))
         (output-file nil))
    (dolist (ext org-view-output-file-extensions)
      (unless output-file
        (when (file-exists-p
               (concat dir basename "." ext))
          (setq output-file (concat dir basename "." ext)))))
    (if output-file
        (if (member (file-name-extension output-file) org-view-external-file-extensions)
            (browse-url-xdg-open output-file)
          (pop-to-buffer (or (find-buffer-visiting output-file)
                             (find-file-noselect output-file))))
      (message "No exported file found"))))

(defvar org-view-output-file-extensions '("pdf" "md" "rst" "txt" "tex" "html")
  "Search for output files with these extensions.")
(defvar org-view-external-file-extensions '("html")
  "File formats that should be opened externally.")
#+end_src

**** LSP

Add LSP support inside ~src~ blocks.

#+begin_src emacs-lisp
(cl-defmacro lsp-org-babel-enable (lang)
  "Support LANG in org source code block."
  (cl-check-type lang stringp)
  (let* ((edit-pre (intern (format "org-babel-edit-prep:%s" lang)))
         (intern-pre (intern (format "lsp--%s" (symbol-name edit-pre)))))
    `(progn
       (defun ,intern-pre (info)
         (let ((file-name (->> info caddr (alist-get :file))))
           (unless file-name
             (setq file-name (make-temp-file "babel-lsp-")))
           (setq buffer-file-name file-name)
           (lsp-deferred)))
       (put ',intern-pre 'function-documentation
            (format "Enable lsp-mode in the buffer of org source block (%s)."
                    (upcase ,lang)))
       (if (fboundp ',edit-pre)
           (advice-add ',edit-pre :after ',intern-pre)
         (progn
           (defun ,edit-pre (info)
             (,intern-pre info))
           (put ',edit-pre 'function-documentation
                (format "Prepare local buffer environment for org source block (%s)."
                        (upcase ,lang))))))))
(defvar org-babel-lang-list
  '("rust" "python" "jupyter-python" "bash" "sh"))
(dolist (lang org-babel-lang-list)
  (eval `(lsp-org-babel-enable ,lang)))
#+end_src

** eBooks

*** calibredb

Read the calibre eBook library.

#+begin_src emacs-lisp :tangle packages.el
(package! calibredb :pin "99a234167a092bc0017d11c814f0b8c0da53a107")
#+end_src

#+begin_src emacs-lisp
(use-package! calibredb
  :commands calibredb
  :config
  (setq calibredb-root-dir "~/Documents/books/calibre"
        calibredb-db-dir (expand-file-name "metadata.db" calibredb-root-dir)
        sql-sqlite-program (if IS-WINDOWS "sqlite3.exe" "sqlite3"))

  (map! :map calibredb-show-mode-map
        :ne "?" #'calibredb-entry-dispatch
        :ne "o" #'calibredb-find-file
        :ne "O" #'calibredb-find-file-other-frame
        :ne "V" #'calibredb-open-file-with-default-tool
        :ne "s" #'calibredb-set-metadata-dispatch
        :ne "e" #'calibredb-export-dispatch
        :ne "q" #'calibredb-entry-quit
        :ne "." #'calibredb-open-dired
        :ne [tab] #'calibredb-toggle-view-at-point
        :ne "M-t" #'calibredb-set-metadata--tags
        :ne "M-a" #'calibredb-set-metadata--author_sort
        :ne "M-A" #'calibredb-set-metadata--authors
        :ne "M-T" #'calibredb-set-metadata--title
        :ne "M-c" #'calibredb-set-metadata--comments)

  (map! :map calibredb-search-mode-map
        :ne [mouse-3] #'calibredb-search-mouse
        :ne "RET" #'calibredb-find-file
        :ne "?" #'calibredb-dispatch
        :ne "a" #'calibredb-add
        :ne "A" #'calibredb-add-dir
        :ne "c" #'calibredb-clone
        :ne "d" #'calibredb-remove
        :ne "D" #'calibredb-remove-marked-items
        :ne "j" #'calibredb-next-entry
        :ne "k" #'calibredb-previous-entry
        :ne "l" #'calibredb-virtual-library-list
        :ne "L" #'calibredb-library-list
        :ne "n" #'calibredb-virtual-library-next
        :ne "N" #'calibredb-library-next
        :ne "p" #'calibredb-virtual-library-previous
        :ne "P" #'calibredb-library-previous
        :ne "s" #'calibredb-set-metadata-dispatch
        :ne "S" #'calibredb-switch-library
        :ne "o" #'calibredb-find-file
        :ne "O" #'calibredb-find-file-other-frame
        :ne "v" #'calibredb-view
        :ne "V" #'calibredb-open-file-with-default-tool
        :ne "." #'calibredb-open-dired
        :ne "b" #'calibredb-catalog-bib-dispatch
        :ne "e" #'calibredb-export-dispatch
        :ne "r" #'calibredb-search-refresh-and-clear-filter
        :ne "R" #'calibredb-search-clear-filter
        :ne "q" #'calibredb-search-quit
        :ne "m" #'calibredb-mark-and-forward
        :ne "f" #'calibredb-toggle-favorite-at-point
        :ne "x" #'calibredb-toggle-archive-at-point
        :ne "h" #'calibredb-toggle-highlight-at-point
        :ne "u" #'calibredb-unmark-and-forward
        :ne "i" #'calibredb-edit-annotation
        :ne "DEL" #'calibredb-unmark-and-backward
        :ne [backtab] #'calibredb-toggle-view
        :ne [tab] #'calibredb-toggle-view-at-point
        :ne "M-n" #'calibredb-show-next-entry
        :ne "M-p" #'calibredb-show-previous-entry
        :ne "/" #'calibredb-search-live-filter
        :ne "M-t" #'calibredb-set-metadata--tags
        :ne "M-a" #'calibredb-set-metadata--author_sort
        :ne "M-A" #'calibredb-set-metadata--authors
        :ne "M-T" #'calibredb-set-metadata--title
        :ne "M-c" #'calibredb-set-metadata--comments)

  (set-popup-rules!
    '(("\\*calibredb-entry\\*" :side right :size 0.5 :quit nil :modeline t))))
#+end_src

*** nov

Use =nov= to read eBooks.

#+begin_src emacs-lisp :tangle packages.el
(package! nov :pin "933816c190633fa1f2f0667ba105d1311572b3c6")
#+end_src

#+begin_src emacs-lisp
(use-package! nov
  :mode ("\\.epub\\'" . nov-mode)
  :config
  (map! :map nov-mode-map
        :n "H" #'nov-previous-document
        :n "L" #'nov-next-document
        :n "[" #'nov-previous-document
        :n "]" #'nov-next-document
        :n "d" #'nov-scroll-up
        :n "u" #'nov-scroll-down
        :n "J" #'nov-scroll-up
        :n "K" #'nov-scroll-down
        :n "gf" #'follow-mode
        :n "gm" #'nov-display-metadata
        :n "gp" #'my-nov-document-position
        :n "gr" #'nov-render-document
        :n "gt" #'nov-goto-toc
        :n "gv" #'nov-view-source
        :n "gV" #'nov-view-content-source
        :n [return]         #'nov-scroll-up
        :n [(shift return)] #'nov-scroll-down)

  (defun my-nov-document-position ()
    (interactive)
    (message "%d/%d"
             (1+ nov-documents-index)
             (length nov-documents)))

  (advice-add 'nov-render-title :override #'ignore)

  (defun +nov-mode-setup ()
    (setq-local line-spacing 0.4
                mode-line-format nil
                nov-text-width 80
                shr-use-colors nil
                visual-fill-column-center-text t
                visual-fill-column-width 90)

    (buffer-face-mode 1)
    (visual-line-mode 1)
    (visual-fill-column-mode 1)
    (hl-line-mode 0)
    (follow-mode 1)

    (add-to-list '+lookup-definition-functions #'+lookup/dictionary-definition)))

(add-hook 'nov-mode-hook #'+nov-mode-setup)
#+end_src

** Emacs Application Framework

#+begin_src emacs-lisp :tangle packages.el
(package! eaf
  :recipe (:host github :repo "emacs-eaf/emacs-application-framework"
           :files ("app" "core" "*.el" "*.py"))
  :pin "ada92215ad864c2d142feb6ad6e1127e90bce668")
#+end_src

#+begin_src emacs-lisp
(use-package! eaf
  :defer t
  :config
  (setq eaf-browser-dark-mode nil
        eaf-browser-default-search-engine "duckduckgo"
        eaf-browser-blank-page-url "https://start.duckduckgo.com"
        eaf-browser-enable-adblocker t
        eaf-browser-remember-history nil
        eaf-enable-debug nil
        eaf-fullscreen-p nil
        eaf-kill-process-after-last-buffer-closed t
        eaf-markdown-dark-mode nil
        eaf-pdf-dark-mode "ignore"
        eaf-start-python-process-when-require t
        eaf-terminal-dark-mode nil
        eaf-webengine-default-zoom 2.0
        eaf-webengine-font-size 14
        eaf-webengine-fixed-font-size 14
        eaf-webengine-scroll-step 200)

  (require 'eaf-browser)
  (require 'eaf-pdf-viewer)

  (define-key key-translation-map (kbd "SPC")
    (lambda (prompt)
      (if (derived-mode-p 'eaf-mode)
        (pcase eaf--buffer-app-name
            ("browser" (if (eaf-call-sync "execute_function" eaf--buffer-id "is_focus")
                           (kbd "SPC")
                         (kbd eaf-evil-leader-key)))
            ("pdf-viewer" (kbd eaf-evil-leader-key))
            ("image-viewer" (kbd eaf-evil-leader-key))
            ("mindmap" (kbd eaf-evil-leader-key))
            ("markdown-previewer" (kbd eaf-evil-leader-key))
            ("music-player" (kbd eaf-evil-leader-key))
            ("video-player" (kbd eaf-evil-leader-key))
            (_  (kbd "SPC")))
        (kbd "SPC")))))
#+end_src

** LSP LTEX

Config from https://github.com/doomemacs/doomemacs/pull/6683.

#+begin_src emacs-lisp :tangle packages.el
(package! lsp-ltex :pin "7870f252562eda24c56567576336651e2a986c25")
#+end_src

#+begin_src emacs-lisp
(use-package! lsp-ltex
  :commands (+lsp-ltex-toggle
             +lsp-ltex-enable
             +lsp-ltex-disable
             +lsp-ltex-setup)

  :hook ((org-mode latex-mode LaTeX-mode markdown-mode) . #'+lsp-ltex-setup)

  :config
  (add-to-list 'lsp-language-id-configuration '(doom-docs-org-mode . "org"))

  :init
  (setq lsp-ltex-language "en"
        lsp-ltex-log-level "warning"
        lsp-ltex-diagnostic-severity "warning"
        lsp-ltex-user-rules-path (expand-file-name "lsp-ltex" doom-data-dir)
        lsp-ltex-disabled-rules '(:en ["EN_QUOTES" "OXFORD_SPELLING_Z_NOT_S"]))

  ;; When n-gram data sets are available, use them to detect errors with words
  ;; that are often confused (like their and there).
  (when (file-directory-p "/usr/share/ngrams")
    (setq lsp-ltex-additional-rules-language-model "/usr/share/ngrams"))

  (defvar +lsp-ltex-disabled-modes '(org-msg-edit-mode))

  (defun +lsp-ltex-setup ()
    "Load LTeX LSP server."
    (interactive)
    (require 'lsp-ltex)
    (when (and (+lsp-ltex--enabled-p)
               (not (memq major-mode +lsp-ltex-disabled-modes)))
      (lsp-deferred)))

  (defun +lsp-ltex--enabled-p ()
    (not (memq 'ltex-ls lsp-disabled-clients)))

  (defun +lsp-ltex-enable ()
    "Enable LTeX LSP for the current buffer."
    (interactive)
    (unless (+lsp-ltex--enabled-p)
      (setq-local lsp-disabled-clients (delq 'ltex-ls lsp-disabled-clients))
      (message "Enabled ltex-ls"))
    (+lsp-ltex-setup))

  (defun +lsp-ltex-disable ()
    "Disable LTeX LSP for the current buffer."
    (interactive)
    (when (+lsp-ltex--enabled-p)
      (setq-local lsp-disabled-clients (cons 'ltex-ls lsp-disabled-clients))
      (lsp-disconnect)
      (message "Disabled ltex-ls")))

  (defun +lsp-ltex-toggle ()
    "Toggle LTeX LSP for the current buffer."
    (interactive)
    (if (+lsp-ltex--enabled-p)
        (+lsp-ltex-disable)
      (+lsp-ltex-enable)))

  (map! :localleader
        :map (text-mode-map latex-mode-map LaTeX-mode-map org-mode-map markdown-mode-map)
        :desc "Toggle grammar check" "G" #'+lsp-ltex-toggle))
#+end_src

** LLM

*** gptel

#+begin_src emacs-lisp :tangle packages.el
(package! gptel :pin "ef24f5f50bdad336ed0f28a0a8a7a0ef2b79c1bf")
#+end_src

#+begin_src emacs-lisp
(defun get-ollama-models ()
  "Fetch the list of installed Ollama models."
  (let* ((output (shell-command-to-string "ollama list"))
         (lines (split-string output "\n" t))
         models)
    (dolist (line (cdr lines))
      (when (string-match "^\\([^[:space:]]+\\)" line)
        (push (match-string 1 line) models)))
    (nreverse models)))

(after! gptel
  (let* ((gptel-anthropic (gptel-make-anthropic "Anthropic"
                            :key #'gptel-api-key-from-auth-source
                            :stream t))

         (gptel-cerebras (gptel-make-openai "Cerebras"
                           :host "api.cerebras.ai"
                           :endpoint "/v1/chat/completions"
                           :stream t
                           :key #'gptel-api-key-from-auth-source
                           :models '(zai-glm-4.6)))

         (gptel-gemini (gptel-make-gemini "Gemini"
                         :key (getenv "GEMINI_API_KEY")
                         :stream t))

         (gptel-mistral (gptel-make-openai "mistral"
                          :host "api.mistral.ai"
                          :key #'gptel-api-key-from-auth-source
                          :models '("mistral-large-latest" "open-codestral-mamba")
                          :stream t))

         (gptel-ollama (gptel-make-ollama "Ollama"
                         :host "localhost:11434"
                         :models (get-ollama-models)
                         :stream t
                         :request-params '(:keep_alive "30m"))))

    (setq gptel-backend gptel-cerebras
          gptel-model 'zai-glm-4.6
          gptel-default-mode 'org-mode
          gptel-display-buffer-action 'display-buffer-same-window)

    (setf (alist-get 'org-mode gptel-prompt-prefix-alist) "** \n\n"
          (alist-get 'org-mode gptel-response-prefix-alist) "*** \n\n")

    (add-hook 'gptel-post-stream-hook 'gptel-auto-scroll))

  (map! :leader
        (:prefix ("l" . "llm")
         :desc "Add text to context"        "a" #'gptel-add
         :desc "Explain"                    "e" #'gptel-quick
         :desc "Add file to context"        "f" #'gptel-add-file
         :desc "Open gptel"                 "l" #'gptel
         :desc "Send to gptel"              "s" #'gptel-send
         :desc "Open gptel menu"            "m" #'gptel-menu
         :desc "Rewrite"                    "r" #'gptel-rewrite
         :desc "Org: set topic"             "o" #'gptel-org-set-topic
         :desc "Org: set properties"        "O" #'gptel-org-set-properties)))
#+end_src

Open all org-mode buffers with gptel.

#+begin_src emacs-lisp
(after! org
  (add-hook 'org-mode-hook 'gptel-mode))
#+end_src

Call ~gptel-send~ with =C-c RET= only.

#+begin_src emacs-lisp
(after! gptel
  (dolist (key '("RET"
                 "<normal-state> RET"
                 "<visual-state> RET"
                 "<normal-state> S-<return>"
                 "<visual-state> S-<return>"))
    (define-key gptel-mode-map (kbd key) nil)))

(after! org
  (define-key org-mode-map (kbd "C-c <return>") #'gptel-send))
#+end_src

Don't save or restore gptel state to org buffer.

#+begin_src emacs-lisp
(defcustom inhibit-gptel-org-save nil
  "Non-nil to inhibit saving gptel state.")
(defcustom inhibit-gptel-org-restore nil
  "Non-nil to inhibit restoring gptel state.")

(advice-add 'gptel-org--save-state :around
            (lambda (orig-fun &rest args)
              (unless inhibit-gptel-org-save (apply orig-fun args))))

(advice-add 'gptel-org--restore-state :around
            (lambda (orig-fun &rest args)
              (when (and (not inhibit-gptel-org-restore)
                         (org-entry-get (point-min) "GPTEL_BOUNDS"))
                (apply orig-fun args))))

(add-hook 'gptel-save-state-hook
          (lambda () (setq-local inhibit-gptel-org-save t)))
(add-hook 'gptel-mode-hook
          (lambda () (setq-local inhibit-gptel-org-restore t)))
#+end_src

*** agent-shell

#+begin_src emacs-lisp :tangle packages.el
(package! shell-maker)
(package! acp
  :recipe (:host github :repo "xenodium/acp.el")
  :pin "9caa610d8d56b1001c6a5d17bddb508f1734f5b6")
(package! agent-shell
  :recipe (:host github :repo "xenodium/agent-shell")
  :pin "5105919ee0a146e3746df54539294c464c0d065a")
#+end_src

#+begin_src emacs-lisp
(use-package! agent-shell
  :config
  (defvar my-agent-shell-anthropic-env-vars
    (agent-shell-make-environment-variables
      "ANTHROPIC_API_KEY_USE" "https://docs.z.ai/scenario-example/develop-tools/claude"
      "ANTHROPIC_API_KEY" (getenv "ZAI_API_KEY")
      "ANTHROPIC_BASE_URL" "https://api.z.ai/api/anthropic"
      "ANTHROPIC_MODEL" "GLM-4.6"
      "ANTHROPIC_SMALL_FAST_MODEL" "GLM-4.5-Air"
      "ANTHROPIC_DEFAULT_OPUS_MODEL" "GLM-4.6"
      "ANTHROPIC_DEFAULT_SONNET_MODEL" "GLM-4.6"
      "ANTHROPIC_DEFAULT_HAIKU_MODEL" "GLM-4.5-Air"))

  (setq agent-shell-anthropic-claude-environment my-agent-shell-anthropic-env-vars
        agent-shell-file-completion-enabled t))
#+end_src

*** Voice

#+begin_src emacs-lisp
(defvar my-voice-debug nil)
(defvar my-voice-recording-active nil)
(defvar my-voice-recording-filename nil)
(defvar my-voice-recording-process nil)

(defun my-start-voice-recording ()
  "Start voice recording."
  (interactive)
  (when (not my-voice-recording-active)
    (let* ((timestamp (format-time-string "%Y-%m-%dT%H%M%S"))
           (wav-file (expand-file-name (format "sox_%s.wav" timestamp) temporary-file-directory))
           (sox-app (expand-file-name "~/.nix-profile/Applications/Sox.app")))

      (setq my-voice-recording-active t
            my-voice-recording-filename wav-file
            my-voice-recording-process
            (if (eq system-type 'darwin)
                (start-process "voice-rec" nil "open" "-a" sox-app "--args" wav-file)
              (start-process "voice-rec" nil "parecord" "--channels" "1" "--latency-msec" "50" wav-file)))

      (message "Recording started: %s" wav-file))))

(defun my-stop-voice-recording ()
  "Stop voice recording and transcribe."
  (interactive)
  (when my-voice-recording-process
    (let* ((wav-file my-voice-recording-filename)
           (mp3-file (concat (file-name-sans-extension wav-file) ".mp3")))
            
      (sleep-for 0.1)
      (if (eq system-type 'darwin)
          (call-process "pkill" nil nil nil "sox")
        (signal-process my-voice-recording-process 'SIGTERM))

      (start-process "voice-mp3" nil "sox" wav-file mp3-file)
      (sleep-for 0.1)
    
      (setq my-voice-recording-active nil
            my-voice-recording-process nil)
      (message "Recording converted: %s" mp3-file)
      
      (my-transcribe-voice mp3-file)
      (gptel-send))))

(defun my-transcribe-voice (mp3-file)
  "Transcribe audio file using Mistral API."
  (let* ((api-url "https://api.mistral.ai/v1/audio/transcriptions")
         (api-key (getenv "MISTRAL_API_KEY"))
         (api-model "voxtral-mini-latest")
         (curl (format "curl -s -L '%s' --header 'x-api-key: %s' --form 'model=%s' --form 'file=@%s'"
                        api-url api-key api-model mp3-file))
         (response (shell-command-to-string curl))
         (json (json-parse-string response)))

    (when my-voice-debug
      (message "DEBUG: Transcription response: %s" response))
    
    (if-let ((error-msg (gethash "message" json)))
        (message "Transcription error: %s" error-msg)
      (when-let ((text (gethash "text" json)))
        (insert text)
        (message "Audio transcribed.")))))

(if (eq system-type 'gnu/linux)
    (progn
      (global-set-key (kbd "s-<Launch8>") 'my-start-voice-recording)
      (global-set-key (kbd "s-<Launch9>") 'my-stop-voice-recording))
  (progn
    (global-set-key [f18] 'my-start-voice-recording)
    (global-set-key [f19] 'my-stop-voice-recording)))
#+end_src

* Functions

** Search

Search string variable values by some pattern.

#+begin_src emacs-lisp
(defun search-variables-by-value (pattern)
  "Search for variables whose values match PATTERN."
  (interactive "sEnter value pattern (regexp): ")
  (let ((result '()))
    (mapatoms (lambda (sym)
                (when (and (boundp sym)      ; Ensure the symbol is a variable
                           (stringp (symbol-value sym)) ; Check if the value is a string
                           (string-match pattern (symbol-value sym))) ; Match the pattern
                  (push (list sym (symbol-value sym)) result))))
    (if result
        (with-output-to-temp-buffer "*Variable Search*"
          (dolist (entry result)
            (princ (format "%s : %s\n" (car entry) (cadr entry)))))
      (message "No match found."))))
#+end_src

* Languages

** Text

Display ANSI colour codes.

#+begin_src emacs-lisp
(after! text-mode
  (add-hook! 'text-mode-hook
             (with-silent-modifications
               (ansi-color-apply-on-region (point-min) (point-max) t))))
#+end_src

** Markdown

Mimic the style of markdown renderers.

#+begin_src emacs-lisp
(custom-set-faces!
  '(markdown-header-face-1 :height 1.25 :weight extra-bold :inherit markdown-header-face)
  '(markdown-header-face-2 :height 1.15 :weight bold       :inherit markdown-header-face)
  '(markdown-header-face-3 :height 1.08 :weight bold       :inherit markdown-header-face)
  '(markdown-header-face-4 :height 1.00 :weight bold       :inherit markdown-header-face)
  '(markdown-header-face-5 :height 0.90 :weight bold       :inherit markdown-header-face)
  '(markdown-header-face-6 :height 0.75 :weight extra-bold :inherit markdown-header-face))
#+end_src

Make format errors popup small and quit-able.

#+begin_src emacs-lisp
(set-popup-rule! "\\*format-all-errors\\*" :ttl 0 :quit t)
#+end_src

** LSP

#+begin_src emacs-lisp
(after! lsp
  (setq lsp-enable-file-watchers nil
        +lsp-defer-shutdown 60)

  (set-popup-rules!
    '(("\\*lsp-help\\*" :side right :size 0.33 :quit nil :modeline t)))

  (set-formatter! 'lsp-formatter #'lsp-format-buffer
                  :modes '(lsp-mode)))

(after! lsp-ui
  (setq lsp-ui-doc-enable nil
        lsp-signature-render-documentation nil))
#+end_src

** Rust

#+begin_src emacs-lisp
(after! rustic
  (setq rustic-lsp-server 'rust-analyzer
        rustic-default-clippy-arguments "--benches --tests --all-features -- -D warnings -D rust-2018-idioms"
        rustic-format-trigger 'on-save
        rustic-test-arguments "--all-features"
        rust-mode-treesitter-derive t
        lsp-rust-all-features t
        lsp-rust-analyzer-cargo-watch-command "check"
        lsp-rust-analyzer-cargo-watch-args ["--all-features", " --", "-D", "warnings", "-D", "rust-2018-idioms"]
        lsp-rust-analyzer-import-granularity "module"
        lsp-rust-clippy-preference "on")

  (set-popup-rules!
   '(("\\*cargo-*" :side right :size 0.33 :quit nil :modeline t)
     ("\\*rustic-*" :side right :size 0.33 :quit nil :modeline t)))

  (map! :localleader
        :map rustic-mode-map

        :desc "Execute code action" "a" #'lsp-execute-code-action
        :desc "Toggle inlay hints"  "h" #'lsp-rust-analyzer-inlay-hints-mode
        :desc "Join lines"          "j" #'lsp-rust-analyzer-join-lines
        :desc "Expand macro"        "x" #'lsp-rust-analyzer-expand-macro

        :desc "Cargo Clippy"        "c" #'rustic-cargo-clippy
        :desc "Cargo Format"        "f" #'rustic-cargo-fmt
        :desc "Cargo Check"         "k" #'rustic-cargo-check

        (:prefix ("t" . "cargo test")
          :desc "run tests"     "t" #'rustic-cargo-test
          :desc "run last test" "l" #'rustic-cargo-test-rerun
          :desc "test current"  "c" #'rustic-cargo-current-test)

        (:prefix ("g" . "goto")
          :desc "Definition"      "d" #'lsp-find-definition
          :desc "Implementation"  "i" #'lsp-find-implementation
          :desc "Reference"       "r" #'lsp-find-references
          :desc "Type definition" "t" #'lsp-find-type-definition)))
#+end_src

** Python

#+begin_src emacs-lisp
(after! ob-jupyter
  (setq org-babel-jupyter-resource-directory "~/.config/emacs/.local/cache/jupyter")
  (org-babel-jupyter-aliases-from-kernelspecs))
#+end_src

Disable ZeroMQ in macOS.

#+begin_src emacs-lisp :tangle (if IS-MAC "yes" "no")
(setq jupyter-use-zmq nil)
#+end_src

** Nix

#+begin_src emacs-lisp
(after! nix-mode
  (set-popup-rules!
   '(("\\*compilation\\*" :side right :size 0.33 :quit nil :modeline t)
     ("\\*documentation\\*" :side right :size 0.33 :quit nil :modeline t))))
#+end_src

** Protobuf

#+begin_src emacs-lisp :tangle packages.el
(package! protobuf-mode
  :recipe (:host github :repo "protocolbuffers/protobuf"
           :files ("protobuf-mode.el" "editors/*.el"))
  :pin "a93c97116fefb530f3d1c6fbc43d1aec1d926ccb")
#+end_src

#+begin_src emacs-lisp
(after! protobuf-mode
  (defun flycheck-protobuf-buf-project-root (&optional _checker)
    "Return the nearest directory holding the buf.yaml configuration."
    (and buffer-file-name
        (locate-dominating-file buffer-file-name "buf.yaml")))

  (flycheck-define-checker protobuf-buf
    "A protobuf syntax checker: `https://github.com/bufbuild/buf'"
    :command ("buf" "lint" "--path" source-original)
    :error-patterns
    ((warning line-start (file-name) ":" line ":" column ":" (message) line-end))
    :modes protobuf-mode
    :enabled flycheck-protobuf-buf-project-root
    :working-directory flycheck-protobuf-buf-project-root
    :predicate flycheck-buffer-saved-p)

  (add-to-list 'flycheck-checkers 'protobuf-buf))

(after! apheleia
  (add-to-list 'apheleia-formatters '(buf . ("buf" "format" buffer-file-name)))
  (add-to-list 'apheleia-mode-alist '(protobuf-mode . buf)))
#+end_src

** Autohotkey

#+begin_src emacs-lisp :tangle packages.el
(package! ahk-mode
  :recipe (:host github :repo "punassuming/ahk-mode" :files ("*.el"))
  :pin "729007b5f22a49f5187ff47fca18c0d674e73047")
#+end_src

#+begin_src emacs-lisp
(after! ahk-mode
  (add-to-list 'auto-mode-alist '("\\.ahk$" . ahk-mode))
  (add-hook 'ahk-mode-hook 'display-line-numbers-mode))
#+end_src

** Move

#+begin_src emacs-lisp :tangle packages.el
(package! move-mode
  :recipe (:host github :repo "amnn/move-mode" :files ("*.el"))
  :pin "6e4aaf6aae1e9b4aee096557c9f7b1f3550a1e59")
#+end_src

#+begin_src emacs-lisp
(after! move-mode
  (add-to-list 'auto-mode-alist '("\\.move" . move-mode))
  (add-to-list 'lsp-language-id-configuration '(move-mode . "move"))

  (lsp-register-client
   (make-lsp-client
    :new-connection (lsp-stdio-connection (lambda () "move-analyzer"))
    :major-modes '(move-mode)
    :priority 1
    :library-folders-fn (lambda (_workspace) "~/.move/")
    :server-id 'move-analyzer)))
#+end_src

** D2

#+begin_src emacs-lisp :tangle packages.el
(package! d2-mode
  :recipe (:host github :repo "andorsk/d2-mode" :files ("*.el"))
  :pin "e1fc7d6c1915acaf476060c0f79b8bdef6bd1952")

(package! ob-d2
  :recipe (:host github :repo "xcapaldi/ob-d2" :files ("*.el"))
  :pin "5d197f8225a9fb4da997235b231abe30049c6825")
#+end_src

#+begin_src emacs-lisp
(use-package! d2-mode
  :config
  (add-to-list 'auto-mode-alist (cons "\\.d2\\'" 'd2-mode))

  (setq d2-flags "--layout elk --sketch"))

(use-package! ob-d2
  :config
  (setq ob-d2-command "d2 --layout elk --sketch"))
#+end_src

** Typst

#+begin_src emacs-lisp :tangle packages.el
(package! typst-ts-mode
  :recipe (:host codeberg :repo "meow_king/typst-ts-mode")
  :pin "7c2ef0d5bd2b5a8727fe6d00938c47ba562e0c94")

(package! typst-preview
  :recipe (:host github :repo "havarddj/typst-preview.el")
  :pin "c685857f2d61133fc268509b39796b2718728f29")

(package! ox-typst
  :recipe (:host github :repo "jmpunkt/ox-typst" :files ("*.el"))
  :pin "ac8893c79fa85a92a9251a695776971526ba8d76")
#+end_src

#+begin_src emacs-lisp
(use-package! typst-ts-mode
  :mode "\\.typ")

(after! lsp-mode
  (add-to-list 'lsp-language-id-configuration '(typst-ts-mode . "typst"))
  (lsp-register-client (make-lsp-client
                        :new-connection (lsp-stdio-connection "tinymist")
                        :activation-fn  (lsp-activate-on "typst")
                        :server-id 'tinymist
                        :initialization-options `(:tinymist (:exportPdf "onSave"))))

  (add-hook 'typst-ts-mode-hook #'lsp! 'append))

(after! apheleia
  (add-to-list 'apheleia-formatters '(typ . ("typstyle" buffer-file-name)))
  (add-to-list 'apheleia-mode-alist '(typst-ts-mode . typ)))

(use-package! ox-typst)
(use-package! websocket)

(use-package! typst-preview
  :after typst-ts-mode

  :init
  (setq typst-preview-autostart t)

  :config
  (map! :map typst-ts-mode-map
        :localleader
        :desc "Compile" "c"   #'typst-ts-compile
        :desc "Preview" "p"   #'typst-preview-mode
        :desc "View"    "v"   #'typst-ts-preview
        :desc "Watch"   "w"   #'typst-ts-watch-mode))
#+end_src
